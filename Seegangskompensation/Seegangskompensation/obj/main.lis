                        .module main.c
                        .area text(rom, con, rel)
 0000                   .dbfile ./main.c
 0000                   .dbfile C:\Users\Lesky\Desktop\Dropbox\Studium\Bechlor\SOFTWA~1\PWM\SEEGAN~1\SEEGAN~1\main.c
 0000                   .dbfunc e LCDansteuern _LCDansteuern fV
 0000           _LCDansteuern::
 0000                   .dbline -1
 0000                   .dbline 20
 0000           ; //----------------------------------------------------------------------------
 0000           ; // C main-Funktion
 0000           ; // Programm: Seegangskompensation bei Krahnanlagen
 0000           ; // Controler: CY8C27446-24PXI
 0000           ; //----------------------------------------------------------------------------
 0000           ; 
 0000           ; #include <m8c.h>        
 0000           ; #include "PSoCAPI.h"    
 0000           ; 
 0000           ; // structur der Prozessdaten
 0000           ; struct 
 0000           ;    {  
 0000           ;       char rgchLCD[15];       //TODO: Arraygröße anpassen                                                   
 0000           ;       char pdchBechleunigung, pdchEntfernung;                 
 0000           ;       char pdchSollwert;                                                              
 0000           ;       char pdchPulsweite;
 0000           ;     } prozess;
 0000           ; 
 0000           ; void LCDansteuern(void)
 0000           ;       {
 0000                   .dbline 22
 0000           ;       // LCD Ansteuern 
 0000           ;       LCD_1_Position(0,5);            
 0000 10                push X
 0001 5705              mov X,5
 0003 5000              mov A,0
 0005 7C0000            xcall _LCD_1_Position
 0008                   .dbline 23
 0008           ;       LCD_1_PrString(prozess.rgchLCD);
 0008 5000              mov A,>_prozess
 000A 08                push A
 000B 5000              mov A,<_prozess
 000D 5C                mov X,A
 000E 18                pop A
 000F 7C0000            xcall _LCD_1_PrString
 0012 20                pop X
 0013                   .dbline -2
 0013           L2:
 0013                   .dbline 0 ; func end
 0013 7F                ret
 0014                   .dbend
 0014                   .dbfunc e Dateneinlesen _Dateneinlesen fV
 0014           _Dateneinlesen::
 0014                   .dbline -1
 0014                   .dbline 27
 0014           ;       }
 0014           ;       
 0014           ; void Dateneinlesen(void)
 0014           ;       {       
 0014                   .dbline 29
 0014           ;       // Wenn Sollwertdaten bereit sind
 0014           ;       if(ADCINC_fIsDataAvailable() != 0)
 0014 10                push X
 0015 7C0000            xcall _ADCINC_fIsDataAvailable
 0018 20                pop X
 0019 3900              cmp A,0
 001B A008              jz L8
 001D                   .dbline 33
 001D           ;                       
 001D           ;               // Einlesen des Sollwertes
 001D           ;               // data ready flag zurüvksetzen        
 001D           ;               prozess.pdchSollwert = ADCINC_cClearFlagGetData();              
 001D 10                push X
 001E 7C0000            xcall _ADCINC_cClearFlagGetData
 0021 20                pop X
 0022 5311              mov [_prozess+17],A
 0024           L7:
 0024                   .dbline 36
 0024           ;                          
 0024           ;       // Auf Entfernung und Position Warten
 0024           ;               while(DUALADC8_fIsDataAvailable == 0);                  
 0024           L8:
 0024                   .dbline 36
 0024 5000              mov A,<PL_DUALADC8_fIsDataAvailable
 0026 10                push X
 0027 5800              mov X,[__r1]
 0029 08                push A
 002A 28                romx
 002B 5300              mov [__r0],A
 002D 18                pop A
 002E 75                inc X
 002F 0900              adc A,0
 0031 28                romx
 0032 20                pop X
 0033 3C0000            cmp [__r0],0
 0036 AFED              jz L7
 0038                   .dbline 38
 0038           ;               // Einlesen der Beschleunigung
 0038           ;               prozess.pdchBechleunigung = DUALADC8_cGetData1();       
 0038 10                push X
 0039 7C0000            xcall _DUALADC8_cGetData1
 003C 20                pop X
 003D 530F              mov [_prozess+15],A
 003F                   .dbline 42
 003F           ;       
 003F           ;               // Einlesen der Entfernung
 003F           ;         // data ready flag zurüvksetzen         
 003F           ;               prozess.pdchEntfernung = DUALADC8_cGetData2ClearFlag();         
 003F 10                push X
 0040 7C0000            xcall _DUALADC8_cGetData2ClearFlag
 0043 20                pop X
 0044 5310              mov [_prozess+16],A
 0046                   .dbline -2
 0046           L3:
 0046                   .dbline 0 ; func end
 0046 7F                ret
 0047                   .dbend
 0047                   .dbfunc e Ausgangansteuern _Ausgangansteuern fV
 0047           ; hichAusgangswert -> X-4
 0047           _Ausgangansteuern::
 0047                   .dbline -1
 0047 10                push X
 0048 4F                mov X,SP
 0049                   .dbline 46
 0049           ;       }
 0049           ; 
 0049           ; void Ausgangansteuern(char hichAusgangswert)
 0049           ;       {
 0049                   .dbline 48
 0049           ;               // linksdrehend 
 0049           ;               if (hichAusgangswert > 0){                              
 0049 5000              mov A,0
 004B 3BFC              cmp A,[X-4]
 004D D00A              jnc L13
 004F           X0:
 004F                   .dbline 49
 004F           ;                       IN1_On;
 004F                   .dbline 49
 004F                   .dbline 50
 004F           ;                       IN2_Off;
 004F                   .dbline 51
 004F           ;                       PWM8_1_WritePulseWidth(prozess.pdchPulsweite);
 004F 10                push X
 0050 5112              mov A,[_prozess+18]
 0052 7C0000            xcall _PWM8_1_WritePulseWidth
 0055 20                pop X
 0056                   .dbline 52
 0056           ;               }
 0056 8019              xjmp L14
 0058           L13:
 0058                   .dbline 54
 0058           ;               // rechtsdrehend
 0058           ;               else if (hichAusgangswert < 0){                         
 0058 3DFC00            cmp [X-4],0
 005B D00D              jnc L16
 005D           X1:
 005D                   .dbline 55
 005D           ;                       IN1_On;
 005D                   .dbline 55
 005D                   .dbline 56
 005D           ;                       IN2_Off;
 005D                   .dbline 57
 005D           ;                       PWM8_1_WritePulseWidth(-prozess.pdchPulsweite);
 005D 5112              mov A,[_prozess+18]
 005F 73                cpl A
 0060 11FF              sub A,-1
 0062 10                push X
 0063 7C0000            xcall _PWM8_1_WritePulseWidth
 0066 20                pop X
 0067                   .dbline 58
 0067           ;               }
 0067 8008              xjmp L17
 0069           L16:
 0069                   .dbline 60
 0069           ;               // Bremsen durch Kurzschluss
 0069           ;               else{                           
 0069                   .dbline 61
 0069           ;                       IN1_On;
 0069                   .dbline 62
 0069           ;                       IN2_On;
 0069                   .dbline 63
 0069           ;                       PWM8_1_WritePulseWidth(0);
 0069 10                push X
 006A 5000              mov A,0
 006C 7C0000            xcall _PWM8_1_WritePulseWidth
 006F 20                pop X
 0070                   .dbline 64
 0070           ;               }
 0070           L17:
 0070           L14:
 0070                   .dbline -2
 0070           L12:
 0070 20                pop X
 0071                   .dbline 0 ; func end
 0071 7F                ret
 0072                   .dbsym l hichAusgangswert -4 c
 0072                   .dbend
 0072                   .dbfunc e main _main fV
 0072           ; kochPeriodendauer -> X+4
 0072           ;         kochKS -> X+3
 0072           ;         kochKP -> X+2
 0072           ; hichBeschleunigungssumme -> X+1
 0072           ; hichAusgangswert -> X+0
 0072           _main::
 0072                   .dbline -1
 0072 10                push X
 0073 4F                mov X,SP
 0074 3805              add SP,5
 0076                   .dbline 68
 0076           ;       }       
 0076           ;               
 0076           ; void main(void)
 0076           ;       {
 0076                   .dbline 70
 0076           ;       // Difinition der Konstanten
 0076           ;       char kochPeriodendauer = 50;                                    
 0076 560432            mov [X+4],50
 0079                   .dbline 81
 0079           ;       char kochKP;
 0079           ;       char kochKS;
 0079           ;               
 0079           ;       // Variablendeklration
 0079           ;       char hichAusgangswert;                                                  
 0079           ;       char hichBeschleunigungssumme;  
 0079           ;               
 0079           ;       // Initialisierung des Controlers
 0079           ;       
 0079           ;       //globale Interrupts Freigeben
 0079           ;       M8C_EnableGInt;                                                 
 0079 7101                      or  F, 01h
 007B           
 007B                   .dbline 84
 007B           ;       
 007B           ;       // Initialisieren des LCD-Displays
 007B           ;       LCD_1_Start();                                                  
 007B 10                push X
 007C 7C0000            xcall _LCD_1_Start
 007F 20                pop X
 0080                   .dbline 87
 0080           ;       
 0080           ;       // Initialisieren des PWM-Moduls
 0080           ;       PWM8_1_WritePeriod(kochPeriodendauer);                              
 0080 10                push X
 0081 5204              mov A,[X+4]
 0083 7C0000            xcall _PWM8_1_WritePeriod
 0086                   .dbline 88
 0086           ;     PWM8_1_Start();
 0086 7C0000            xcall _PWM8_1_Start
 0089                   .dbline 91
 0089           ;       
 0089           ;       // Initialisieren der Verstärker
 0089           ;       PGA_1_SetGain(PGA_1_G0_12);                                             
 0089 5010              mov A,16
 008B 7C0000            xcall _PGA_1_SetGain
 008E                   .dbline 92
 008E           ;       PGA_2_SetGain(PGA_2_G0_12);
 008E 5010              mov A,16
 0090 7C0000            xcall _PGA_2_SetGain
 0093                   .dbline 93
 0093           ;       PGA_3_SetGain(PGA_3_G0_12);
 0093 5010              mov A,16
 0095 7C0000            xcall _PGA_3_SetGain
 0098                   .dbline 95
 0098           ;       
 0098           ;       PGA_1_Start(PGA_1_LOWPOWER);
 0098 5001              mov A,1
 009A 7C0000            xcall _PGA_1_Start
 009D                   .dbline 96
 009D           ;       PGA_2_Start(PGA_2_LOWPOWER);
 009D 5001              mov A,1
 009F 7C0000            xcall _PGA_2_Start
 00A2                   .dbline 97
 00A2           ;       PGA_3_Start(PGA_3_LOWPOWER);    
 00A2 5001              mov A,1
 00A4 7C0000            xcall _PGA_3_Start
 00A7                   .dbline 101
 00A7           ;       
 00A7           ;       // Initialisieren des Dualen AD-Wandlers
 00A7           ;       // für Entfernung und Beschleunigung
 00A7           ;       DUALADC8_Start(DUALADC8_HIGHPOWER);                     
 00A7 5003              mov A,3
 00A9 7C0000            xcall _DUALADC8_Start
 00AC                   .dbline 102
 00AC           ;       DUALADC8_SetCalcTime(100);                              
 00AC 5700              mov X,0
 00AE 5064              mov A,100
 00B0 7C0000            xcall _DUALADC8_SetCalcTime
 00B3                   .dbline 103
 00B3           ;       DUALADC8_GetSamples(); 
 00B3 7C0000            xcall _DUALADC8_GetSamples
 00B6                   .dbline 107
 00B6           ;       
 00B6           ;       // Initialisieren des AD-Wandlers
 00B6           ;       // für den Sollwert
 00B6           ;       ADCINC_Start(ADCINC_HIGHPOWER);                         
 00B6 5003              mov A,3
 00B8 7C0000            xcall _ADCINC_Start
 00BB                   .dbline 108
 00BB           ;       ADCINC_GetSamples(0);                                   
 00BB 5000              mov A,0
 00BD 7C0000            xcall _ADCINC_GetSamples
 00C0 20                pop X
 00C1                   .dbline 111
 00C1           ;       
 00C1           ;       //Initialisieren der Digitalen Ausgänge
 00C1           ;       IN1_Start;      
 00C1                   .dbline 112
 00C1           ;       IN2_Start;
 00C1                   .dbline 113
 00C1           ;       SELBSTTEST_Start;
 00C1 8044              xjmp L21
 00C3           L20:
 00C3                   .dbline 116
 00C3           ;       
 00C3           ;       // Endlosschleife
 00C3           ;       while(1) {
 00C3                   .dbline 119
 00C3           ;       
 00C3           ;               // Daten Einlesen
 00C3           ;               Dateneinlesen();
 00C3 9F4F              xcall _Dateneinlesen
 00C5                   .dbline 123
 00C5           ;                                        
 00C5           ;               // Parameter Berechnen
 00C5           ;               
 00C5           ;               hichBeschleunigungssumme = hichBeschleunigungssumme + prozess.pdchBechleunigung;
 00C5 510F              mov A,[_prozess+15]
 00C7 0501              add [X+1],A
 00C9                   .dbline 125
 00C9           ;               
 00C9           ;               hichAusgangswert = ( prozess.pdchSollwert - prozess.pdchBechleunigung ) * kochKP
 00C9 5203              mov A,[X+3]
 00CB 08                push A
 00CC 5001              mov A,1
 00CE 08                push A
 00CF 7C0000            xcall __divmodu_8X8_8
 00D2 18                pop A
 00D3 5300              mov [__r0],A
 00D5 38FF              add SP,-1
 00D7 5201              mov A,[X+1]
 00D9 60E8              mov REG[0xe8],A
 00DB 5100              mov A,[__r0]
 00DD 60E9              mov REG[0xe9],A
 00DF 40                nop
 00E0 5DEB              mov A,REG[0xeb]
 00E2 5300              mov [__r0],A
 00E4 5111              mov A,[_prozess+17]
 00E6 120F              sub A,[_prozess+15]
 00E8 5300              mov [__r2],A
 00EA 5202              mov A,[X+2]
 00EC 60E8              mov REG[0xe8],A
 00EE 5100              mov A,[__r2]
 00F0 60E9              mov REG[0xe9],A
 00F2 40                nop
 00F3 5DEB              mov A,REG[0xeb]
 00F5 1200              sub A,[__r0]
 00F7 5400              mov [X+0],A
 00F9                   .dbline 128
 00F9           ;                                                       - 1 / kochKS * hichBeschleunigungssumme;
 00F9           ;               //TODO: Korekturfaktor Einfügen 
 00F9           ;               prozess.pdchPulsweite = hichAusgangswert; 
 00F9 5200              mov A,[X+0]
 00FB 5312              mov [_prozess+18],A
 00FD                   .dbline 130
 00FD           ;               
 00FD           ;               Ausgangansteuern(hichAusgangswert);
 00FD 5200              mov A,[X+0]
 00FF 08                push A
 0100 9F45              xcall _Ausgangansteuern
 0102 38FF              add SP,-1
 0104                   .dbline 131
 0104           ;               LCDansteuern();
 0104 9EFA              xcall _LCDansteuern
 0106                   .dbline 133
 0106           ;               
 0106           ;       };
 0106           L21:
 0106                   .dbline 116
 0106 8FBC              xjmp L20
 0108           X2:
 0108                   .dbline -2
 0108           L19:
 0108 38FB              add SP,-5
 010A 20                pop X
 010B                   .dbline 0 ; func end
 010B 8FFF              jmp .
 010D                   .dbsym l kochPeriodendauer 4 c
 010D                   .dbsym l kochKS 3 c
 010D                   .dbsym l kochKP 2 c
 010D                   .dbsym l hichBeschleunigungssumme 1 c
 010D                   .dbsym l hichAusgangswert 0 c
 010D                   .dbend
                        .area bss(ram, con, rel)
 0000                   .dbfile C:\Users\Lesky\Desktop\Dropbox\Studium\Bechlor\SOFTWA~1\PWM\SEEGAN~1\SEEGAN~1\main.c
 0000           _prozess::
 0000                   .blkb 19
 0013                   .dbstruct 0 19 .1
 0013                   .dbfield 0 rgchLCD A[15:15]c
 0013                   .dbfield 15 pdchBechleunigung c
 0013                   .dbfield 16 pdchEntfernung c
 0013                   .dbfield 17 pdchSollwert c
 0013                   .dbfield 18 pdchPulsweite c
 0013                   .dbend
 0013                   .dbsym e prozess _prozess S[.1]
                        .area func_lit(rom, con, rel, proclab)
 0000 0000      PL_DUALADC8_fIsDataAvailable:   .word _DUALADC8_fIsDataAvailable
